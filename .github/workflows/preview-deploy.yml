# Build preview from the source branch/PR head and publish to main:/previews/<branch>
# Writes a BUILD_INFO file into the preview so you can confirm the source commit and rrats used.
on:
  push:
    branches:
      - '**'
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: write

jobs:
  build-and-publish-preview:
    runs-on: ubuntu-latest
    if: github.ref != 'refs/heads/main'
    steps:
      - name: Initial checkout (fetch all)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Determine SOURCE_REF and BRANCH_NAME (no in-run expressions)
        # pass GitHub context into step env (safe, no ${ { } } inside script body)
        env:
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          PR_HEAD_REF: ${{ github.event.pull_request.head.ref }}
          HEAD_REF: ${{ github.head_ref }}
          TRIGGER_REF: ${{ github.ref }}
        run: |
          # For PR events, PR_HEAD_SHA and PR_HEAD_REF are set; for push events use TRIGGER_REF.
          if [ -n "$PR_HEAD_SHA" ]; then
            echo "SOURCE_REF=$PR_HEAD_SHA" >> $GITHUB_ENV
            echo "BRANCH_NAME=$PR_HEAD_REF" >> $GITHUB_ENV
          elif [ -n "$HEAD_REF" ]; then
            echo "SOURCE_REF=$HEAD_REF" >> $GITHUB_ENV
            echo "BRANCH_NAME=$HEAD_REF" >> $GITHUB_ENV
          else
            # For push events the trigger ref looks like refs/heads/<branch>
            BR="${TRIGGER_REF##*/}"
            echo "SOURCE_REF=$BR" >> $GITHUB_ENV
            echo "BRANCH_NAME=$BR" >> $GITHUB_ENV
          fi
          echo "Determined SOURCE_REF=${SOURCE_REF} BRANCH_NAME=${BRANCH_NAME}"

      - name: Checkout source commit/branch
        run: |
          # Ensure refs are available and check out the intended source ref.
          # This step uses SOURCE_REF written to GITHUB_ENV above.
          git fetch --prune --unshallow origin || true
          git fetch origin '+refs/heads/*:refs/remotes/origin/*' || true
          echo "Checking out SOURCE_REF=${SOURCE_REF}"
          git checkout "${SOURCE_REF}"

      - name: Debug: show checked-out commit and branch
        run: |
          echo "Current branch/ref: $(git rev-parse --abbrev-ref HEAD || true)"
          echo "Commit: $(git rev-parse HEAD)"
          git log -1 --oneline || true

      - name: Debug: list rrats files in working tree
        run: |
          echo "Listing rrats/ files used for this build:"
          ls -la rrats || true
          git ls-files rrats/** || true
          git ls-files rrats/** > rrats_list.txt || true
          echo "First 20 rrats entries (if any):"
          head -n 20 rrats_list.txt || true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies (same as main workflow)
        run: |
          python -m pip install --upgrade pip
          pip install toml pandas jinja2 astropy numpy

      - name: Run rratalog generator (same as main workflow)
        run: |
          python make_rratalog.py

      - name: Save generated outputs to TMP and include build metadata
        run: |
          TMPDIR=$(mktemp -d)
          echo "TMPDIR=$TMPDIR" >> $GITHUB_ENV
          cp -a rratalog.html index.html "${TMPDIR}/" 2>/dev/null || true
          cp -a rratalog.csv rratalog2.csv "${TMPDIR}/" 2>/dev/null || true
          echo "SOURCE_COMMIT=$(git rev-parse HEAD)" > "${TMPDIR}/BUILD_INFO.txt"
          echo "BRANCH_OR_REF=${BRANCH_NAME}" >> "${TMPDIR}/BUILD_INFO.txt"
          if [ -f rrats_list.txt ]; then
            echo "--- RRATS FILES ---" >> "${TMPDIR}/BUILD_INFO.txt"
            cat rrats_list.txt >> "${TMPDIR}/BUILD_INFO.txt"
          fi
          ls -la "${TMPDIR}" || true
          echo "BUILD_INFO contents:"
          cat "${TMPDIR}/BUILD_INFO.txt" || true

      - name: Checkout main branch (target for preview files)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          persist-credentials: true

      - name: Copy preview into main:/previews/<branch>
        run: |
          if [ -z "${BRANCH_NAME}" ]; then
            if [ -n "$GITHUB_HEAD_REF" ]; then
              BRANCH_NAME="$GITHUB_HEAD_REF"
            else
              BRANCH_NAME="${GITHUB_REF##*/}"
            fi
          fi
          echo "Using BRANCH_NAME=${BRANCH_NAME}"
          TARGET_DIR="previews/${BRANCH_NAME}"
          mkdir -p "${TARGET_DIR}"
          rm -rf "${TARGET_DIR:?}/"*
          cp -a "${TMPDIR}/." "${TARGET_DIR}/" || true
          ls -la "previews" || true
          ls -la "${TARGET_DIR}" || true
          echo "BUILD_INFO at preview:"
          cat "${TARGET_DIR}/BUILD_INFO.txt" || true

      - name: Commit and push preview to main
        uses: EndBug/add-and-commit@v9
        with:
          add: "previews/${{ env.BRANCH_NAME }}"
          message: "chore(preview): publish preview for ${{ env.BRANCH_NAME }} to /previews/${{ env.BRANCH_NAME }}"
          author_name: "github-actions[bot]"
          author_email: "41898282+github-actions[bot]@users.noreply.github.com"
