# Build preview from the source branch/PR head and publish to main:/previews/<branch>
# Writes a BUILD_INFO file into the preview so you can confirm the source commit and rrats used.
on:
  push:
    branches:
      - '**'
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: write

jobs:
  build-and-publish-preview:
    runs-on: ubuntu-latest
    # avoid running on main itself
    if: github.ref != 'refs/heads/main'
    steps:
      - name: Determine source ref (works for push and PR)
        run: |
          # If this is a pull_request event, github.event.pull_request.head.sha is defined
          if [ -n "${{ github.event.pull_request.head.sha }}" ]; then
            echo "SOURCE_REF=${{ github.event.pull_request.head.sha }}" >> $GITHUB_ENV
            echo "SOURCE_REF_TYPE=sha" >> $GITHUB_ENV
          elif [ -n "${{ github.head_ref }}" ]; then
            # github.head_ref contains branch name for PRs
            echo "SOURCE_REF=${{ github.head_ref }}" >> $GITHUB_ENV
            echo "SOURCE_REF_TYPE=branch" >> $GITHUB_ENV
          else
            # fallback to the ref that triggered the workflow (push)
            echo "SOURCE_REF=${{ github.ref }}" >> $GITHUB_ENV
            echo "SOURCE_REF_TYPE=ref" >> $GITHUB_ENV
          fi
          echo "Determined SOURCE_REF=${SOURCE_REF} (type=${SOURCE_REF_TYPE})"

      - name: Checkout source using resolved ref
        uses: actions/checkout@v4
        with:
          ref: ${{ env.SOURCE_REF }}
          fetch-depth: 0
          persist-credentials: true

      - name: Debug: show checked-out commit and branch
        run: |
          echo "Current branch/ref: $(git rev-parse --abbrev-ref HEAD || true)"
          echo "Commit: $(git rev-parse HEAD)"
          git log -1 --oneline || true

      - name: Debug: list rrats files in working tree
        run: |
          echo "Listing rrats/ files used for this build:"
          ls -la rrats || true
          git ls-files rrats/** || true
          # Save rrats file list for inclusion in BUILD_INFO
          git ls-files rrats/** > rrats_list.txt || true
          wc -l rrats_list.txt || true
          head -n 20 rrats_list.txt || true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies (same as main workflow)
        run: |
          python -m pip install --upgrade pip
          pip install toml pandas jinja2 astropy numpy

      - name: Run rratalog generator (same as main workflow)
        run: |
          python make_rratalog.py

      - name: Save generated outputs to TMP and include build metadata
        run: |
          TMPDIR=$(mktemp -d)
          echo "TMPDIR=$TMPDIR" >> $GITHUB_ENV
          # copy generated files
          cp -a rratalog.html index.html "${TMPDIR}/" 2>/dev/null || true
          cp -a rratalog.csv rratalog2.csv "${TMPDIR}/" 2>/dev/null || true
          # include rrats file list and source commit for traceability
          echo "SOURCE_COMMIT=$(git rev-parse HEAD)" > "${TMPDIR}/BUILD_INFO.txt"
          echo "BRANCH_OR_REF=${{ env.SOURCE_REF }}" >> "${TMPDIR}/BUILD_INFO.txt"
          if [ -f rrats_list.txt ]; then
            echo "--- RRATS FILES ---" >> "${TMPDIR}/BUILD_INFO.txt"
            cat rrats_list.txt >> "${TMPDIR}/BUILD_INFO.txt"
          fi
          ls -la "${TMPDIR}" || true
          echo "Preview BUILD_INFO:"
          cat "${TMPDIR}/BUILD_INFO.txt" || true

      - name: Checkout main branch (target for preview files)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          persist-credentials: true

      - name: Copy preview into main:/previews/<branch>
        env:
          BRANCH_NAME: ${{ github.event.pull_request.head.ref || github.ref_name }}
        run: |
          # Normalize BRANCH_NAME for push/PR events
          if [ -z "${BRANCH_NAME}" ]; then
            if [ -n "$GITHUB_HEAD_REF" ]; then
              BRANCH_NAME="$GITHUB_HEAD_REF"
            else
              BRANCH_NAME="${GITHUB_REF##*/}"
            fi
          fi
          echo "Using BRANCH_NAME=${BRANCH_NAME}"
          TARGET_DIR="previews/${BRANCH_NAME}"
          mkdir -p "${TARGET_DIR}"
          rm -rf "${TARGET_DIR:?}/"*
          # copy saved files from TMP into the preview folder
          cp -a "${TMPDIR}/." "${TARGET_DIR}/" || true
          ls -la "previews" || true
          ls -la "${TARGET_DIR}" || true
          echo "Contents of BUILD_INFO:"
          cat "${TARGET_DIR}/BUILD_INFO.txt" || true

      - name: Commit and push preview to main
        uses: EndBug/add-and-commit@v9
        with:
          add: "previews/${{ env.BRANCH_NAME }}"
          message: "chore(preview): publish preview for ${{ env.BRANCH_NAME }} to /previews/${{ env.BRANCH_NAME }}"
          author_name: "github-actions[bot]"
          author_email: "41898282+github-actions[bot]@users.noreply.github.com"
